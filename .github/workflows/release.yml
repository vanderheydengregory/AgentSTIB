name: Build and Release APK

# DÃ©clenche le workflow quand tu push un tag commenÃ§ant par "v"
on:
  push:
    tags:
      - 'v*'  # Ex: v3.1.0, v3.2.0, etc.

jobs:
  build:
    runs-on: ubuntu-latest  # Utilise une machine Ubuntu

    steps:
      # 1. RÃ©cupÃ¨re le code du repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Installe Java 17 (requis pour Android)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Donne les permissions d'exÃ©cution Ã  gradlew
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. Build l'APK en mode release
      - name: Build Release APK
        run: ./gradlew assembleRelease

      # 5. Extrait le versionCode et versionName de build.gradle.kts
      - name: Extract version from build.gradle.kts
        id: get_version
        run: |
          VERSION_CODE=$(grep "versionCode = " app/build.gradle.kts | head -1 | sed 's/[^0-9]*//g')
          VERSION_NAME=$(grep "versionName = " app/build.gradle.kts | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version $VERSION_NAME (code: $VERSION_CODE)"

      # 6. CrÃ©e le fichier version.json automatiquement
      - name: Create version.json
        run: |
          cat > version.json << EOF
          {
            "versionCode": ${{ steps.get_version.outputs.VERSION_CODE }},
            "versionName": "${{ steps.get_version.outputs.VERSION_NAME }}",
            "apkUrl": "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/agent-stib.apk",
            "releaseNotes": "Nouvelle version Agent STIB ${{ steps.get_version.outputs.VERSION_NAME }}",
            "forceUpdate": false,
            "minSupportedVersion": 1
          }
          EOF
          cat version.json

      # 7. Renomme l'APK pour un nom plus propre
      - name: Rename APK
        run: mv app/build/outputs/apk/release/app-release-unsigned.apk agent-stib.apk

      # 8. CrÃ©e la release GitHub avec l'APK et version.json
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            agent-stib.apk
            version.json
          body: |
            ## ðŸš€ Agent STIB ${{ steps.get_version.outputs.VERSION_NAME }}
            
            **Code version:** ${{ steps.get_version.outputs.VERSION_CODE }}
            
            ### ðŸ“¥ Installation
            TÃ©lÃ©chargez `agent-stib.apk` ci-dessous et installez-le sur votre appareil.
            
            ### âœ¨ NouveautÃ©s
            _Voir les commits pour les dÃ©tails des changements_
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
